---
title: "Mods vs. time"
author: COW and VS
output: html_document
---

Load the required libraries.
```{r message=FALSE}
require(dplyr) # for table manipulation
require(tidyr) # for table reshaping
```

Define two helpful functions that we can use to load in all the mods and summarize them.
```{r}
# function that takes a table with individual modification counts and summarizes them
summarizeMods <- function(mod_counts)
{
  # turn peptide count table into long format
  mod_counts %>% gather(mod, count, 4:length(names(mod_counts))) -> mod_counts.long

  # calculate various ratios and odds of modified peptides
  mod_counts.long %>% group_by(mod) %>%
    summarize( sum.mod = sum(count), sum.unmod = sum(unmod), sum.anymod = sum(anymod),
               sum.unmod.for.mod = sum(unmod*(count>0)),
               sum.anymod.for.mod = sum(anymod*(count>0)),
               frac.mod.abs = sum.mod/(sum.anymod + sum.unmod),
               frac.mod.rel = sum.mod/(sum.anymod.for.mod + sum.unmod.for.mod),
               frac.anymod = sum.anymod/(sum.anymod + sum.unmod),
               odds.mod.other = (sum.mod+1)/(sum.anymod.for.mod+sum.unmod.for.mod-sum.mod+1))
}

# function that reads the modification counts for a given sample from disk and
# summarizes them, using the function summarizeMods() to do the heavy lifting
summarizeModsFromCSV <- function(sample, base_name, target_folder)
{
  file_name <- file.path(target_folder, paste(sample, base_name, sep = ''))
  mod_counts <- read.csv(file_name, check.names = FALSE)
  mod_summary <- summarizeMods(mod_counts)
  data.frame(sample = sample, mod_summary)
}
```

Read in all the data, combine into one big table, and save.
```{r}
# read the information about the samples
samples <- read.csv("samples.csv")
# turn to list
sample.list <- as.list(as.character(samples$sample))

# read in all the data, summarize, and combine into one table
data.list <- lapply(sample.list, summarizeModsFromCSV,
                                 "_PSM_mod_counts.csv", "./GeneratedDataFiles/PSMHits")
mods_summary <- do.call(rbind, data.list)

# combine with other info about samples
mods_summary <- inner_join(samples, mods_summary, by = "sample")

write.csv(mods_summary, "./GeneratedDataFiles/mods_vs_time.csv", row.names = FALSE)
```

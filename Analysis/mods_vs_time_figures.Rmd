---
title: "Mods vs. time figures"
author: COW and VS
output: html_document
---

Load the required libraries.
```{r message=FALSE}
require(stringr) # for string manipulation
require(dplyr) # for table manipulation
require(tidyr) # for table manipulation
require(cowplot) # for plotting
```

Read in the previously generated data table:
```{r}
mods_summary <- read.csv("./GeneratedDataFiles/mods_vs_time.csv")
```

## Percent modified as a function of mass shift

This figure is used mainly as example to show the kind of results we're getting.
```{r fig.width=10, fig.height=4, warning=FALSE}
# define standard error function
se <- function(x) sqrt(var(x)/length(x))

# calculate mean and se of percent modified over biol. repeats for each mod,
# and add a column that holds the mod as numerical value
mods_summary %>% group_by(time, mod) %>%
  summarize(percent.mean = 100*mean(frac.mod.abs), percent.se = 100*se(frac.mod.abs)) %>%
  mutate(delta.mass = as.numeric(str_extract(mod, "[\\+\\-]*\\d+"))) -> mods_fractions

# prepare data for plotting
mods_fractions_3h <- filter(mods_fractions, time==3)
mod1_3h_perc <- filter(mods_fractions_3h, mod=='mod1')$percent.mean
mod16_3h_perc <- filter(mods_fractions_3h, mod=='mod16')$percent.mean
mods_fractions_336h <- filter(mods_fractions, time==336)
mod1_336h_perc <- filter(mods_fractions_336h, mod=='mod1')$percent.mean
mod16_336h_perc <- filter(mods_fractions_336h, mod=='mod16')$percent.mean

plot1 <- ggplot(mods_fractions_3h, aes(x=delta.mass, y=percent.mean)) +
  geom_bar(stat="identity", fill='blue') +
  geom_errorbar(aes(ymin = percent.mean-percent.se, ymax = percent.mean+percent.se)) + 
  xlim(-20, 40) +
  scale_y_continuous(limits=c(0,14), expand=c(0, 0)) +
  ylab("Modified peptides (%)") +
  xlab("Mass shift (Da)") +
  draw_line(c(2, 5), c(mod1_3h_perc+.2, mod1_3h_perc+1.), colour='red') +
  draw_line(c(17, 20), c(mod16_3h_perc+.2, mod16_3h_perc+1.), colour='red') +
  draw_label("+1 Da", x=5, y=mod1_3h_perc+1., hjust=0, vjust=0) +
  draw_label("+16 Da", x=20, y=mod16_3h_perc+1., hjust=0, vjust=0) +
  draw_label("3 hours", x=-20, y=13, hjust=0, vjust=0)

plot2 <- ggplot(mods_fractions_336h, aes(x=delta.mass, y=percent.mean)) +
  geom_bar(stat="identity", fill='blue') +
  geom_errorbar(aes(ymin = percent.mean-percent.se, ymax = percent.mean+percent.se)) + 
  xlim(-20, 40) +
  scale_y_continuous(limits=c(0,14), expand=c(0, 0)) +
  ylab("Modified peptides (%)") +
  xlab("Mass shift (Da)") +
  draw_line(c(2, 5), c(mod1_336h_perc+.2, mod1_336h_perc+1.), colour='red') +
  draw_line(c(17, 20), c(mod16_336h_perc+.2, mod16_336h_perc+1.), colour='red') +
  draw_label("+1 Da", x=5, y=mod1_336h_perc+1., hjust=0, vjust=0) +
  draw_label("+16 Da", x=20, y=mod16_336h_perc+1., hjust=0, vjust=0) +
  draw_label("336 hours", x=-20, y=13, hjust=0, vjust=0)

plot_grid(plot1, plot2, labels=c("A", "B"))
```

Are the shown changes statistically different? Let's do t tests of 3h vs 336h:
```{r}
# 3h vs 336h for +1 mod
mods_summary %>% filter(time==3 | time==336, mod=="mod1") %>%
  select(time, biol.rep, frac.mod.abs) %>%
  spread(time, frac.mod.abs) -> mod1.table
t.test(mod1.table$"3", mod1.table$"336", paired=T)

# 3h vs 336h for +16 mod
mods_summary %>% filter(time==3 | time==336, mod=="mod16") %>%
  select(time, biol.rep, frac.mod.abs) %>%
  spread(time, frac.mod.abs) -> mod16.table
t.test(mod16.table$"3", mod16.table$"336", paired=T)
```
In a direct comparison of 3h vs. 336h, neither is significant. However, we will see below that there are significant trends if we look over the entire time course.

## Percent of all mods over time
```{r fig.width=5, fig.height=4}
# extract the +1 modification, just because we need to filter down to one data set
plus1mod <- filter(mods_summary, mod=="mod1")

# absolute fraction of *any* modification over time
plot1 <- ggplot(plus1mod, aes(x=time, y=100*frac.anymod, color=biol.rep)) +
  scale_x_log10(breaks = c(3, 4, 5, 6, 8, 24, 48, 168, 336)) +
  ylim(0, 30) + 
  geom_point() +
  geom_line() +
  ylab("Percent modified peptides") +
  xlab("Time (hours)") +
  scale_color_discrete(name = "Biol. repeat")
plot1
```

The overall percentage of modified peptides doesn't change significantly with time:
```{r}
perc.model <- lm(frac.anymod ~ log(time), data=plus1mod)
summary(perc.model)
```

## +1 Dalton mod
```{r fig.width=10, fig.height=4}
# extract the +1 modification
plus1mod <- filter(mods_summary, mod=="mod1")

# absolute fraction
plot1 <- ggplot(plus1mod, aes(x=time, y=100*frac.mod.abs, color=biol.rep)) +
  scale_x_log10(breaks = c(3, 4, 5, 6, 8, 24, 48, 168, 336)) +
  ylim(0, 15) + 
  geom_point() +
  geom_line() +
  ylab("Percent modified peptides") +
  xlab("Time (hours)") +
  scale_color_discrete(name = "Biol. repeat")

# odds modified to other
plot2 <- ggplot(plus1mod, aes(x=time, y=odds.mod.other, color=biol.rep)) +
  scale_x_log10(breaks = c(3, 4, 5, 6, 8, 24, 48, 168, 336)) +
  scale_y_log10(breaks = c(.03, .04, .05, .06, .07, .08, .09, .1, .2, .3, .4, .5, .6, .7, .8, .9, 1, 2, 3, 4, 5),
                labels = c("0.03", "", "", "", "", "", "", "0.1", "", "0.3", "", "0.5", "", "", "", "", "1.0", "", "3.0", "", ""),
                limits = c(.1, 0.5)) + 
  geom_point() +
  geom_line() +
  ylab("Odds +1 Da / other") +
  xlab("Time (hours)") +
  scale_color_discrete(name = "Biol. repeat")

plot_grid(plot1, plot2, labels = c("A", "B"))
```


The percent modified peptides doesn't change with time, and the odds show a very minor increase:
```{r}
perc.model <- lm(frac.mod.abs ~ log(time), data=plus1mod)
summary(perc.model)
odds.model <- lm(log(odds.mod.other) ~ log(time), data=plus1mod)
summary(odds.model)
```

## +16 Dalton mod
```{r fig.width=10, fig.height=4}
# extract the +16 modification
plus16mod <- filter(mods_summary, mod=="mod16")

# absolute fraction
plot1 <- ggplot(plus16mod, aes(x=time, y=100*frac.mod.abs, color=biol.rep)) +
  scale_x_log10(breaks = c(3, 4, 5, 6, 8, 24, 48, 168, 336)) +
  ylim(0, 15) + 
  geom_point() +
  geom_line() +
  ylab("Percent modified peptides") +
  xlab("Time (hours)") +
  scale_color_discrete(name = "Biol. repeat")

plot2 <- ggplot(plus16mod, aes(x=time, y=odds.mod.other, color=biol.rep)) +
  scale_x_log10(breaks = c(3, 4, 5, 6, 8, 24, 48, 168, 336)) +
  scale_y_log10(breaks = c(.03, .04, .05, .06, .07, .08, .09, .1, .2, .3, .4, .5, .6, .7, .8, .9, 1, 2, 3, 4, 5),
                labels = c("0.03", "", "", "", "", "", "", "0.1", "", "0.3", "", "0.5", "", "", "", "", "1.0", "", "3.0", "", ""),
                limits = c(.1, 1.)) + 
  geom_point() +
  geom_line() +
  ylab("Odds +16 Da / other") +
  xlab("Time (hours)") +
  scale_color_discrete(name = "Biol. repeat")

plot_grid(plot1, plot2, labels = c("A", "B"))
```

The percent modified peptides declines significantly with time, and so do the odds:
```{r}
perc.model <- lm(frac.mod.abs ~ log(time), data=plus16mod)
summary(perc.model)
odds.model <- lm(log(odds.mod.other) ~ log(time), data=plus16mod)
summary(odds.model)
```

## +42 Dalton mod
```{r fig.width=10, fig.height=4}
# extract the +42 modification
plus42mod <- filter(mods_summary, mod=="mod42")

# absolute fraction
plot1 <- ggplot(plus42mod, aes(x=time, y=100*frac.mod.abs, color=biol.rep)) +
  scale_x_log10(breaks = c(3, 4, 5, 6, 8, 24, 48, 168, 336)) +
  ylim(0, .3) + 
  geom_point() +
  geom_line() +
  ylab("Percent modified peptides") +
  xlab("Time (hours)") +
  scale_color_discrete(name = "Biol. repeat")

# odds modified to other
plot2 <- ggplot(plus42mod, aes(x=time, y=odds.mod.other, color=biol.rep)) +
  scale_x_log10(breaks = c(3, 4, 5, 6, 8, 24, 48, 168, 336)) +
  scale_y_log10(breaks = c(.1, .2, .3, .4, .5, .6, .7, .8, .9, 1, 2, 3, 4, 5),
                labels = c("0.1", "", "0.3", "", "0.5", "", "", "", "", "1.0", "", "3.0", "", ""),
                limits = c(.1, 3)) + 
  geom_point() +
  geom_line() +
  ylab("Odds +42 Da / other") +
  xlab("Time (hours)") +
  scale_color_discrete(name = "Biol. repeat")

plot_grid(plot1, plot2, labels = c("A", "B"))
```

The percent modified peptides increases significantly with time, but the odds remain unchanged:
```{r}
perc.model <- lm(frac.mod.abs ~ log(time), data=plus42mod)
summary(perc.model)
odds.model <- lm(log(odds.mod.other) ~ log(time), data=plus42mod)
summary(odds.model)
```

## -2 Dalton mod
```{r fig.width=10, fig.height=4}
# extract the -2 modification
minus2mod <- filter(mods_summary, mod=="mod-2")

# absolute fraction
plot1 <- ggplot(minus2mod, aes(x=time, y=100*frac.mod.abs, color=biol.rep)) +
  scale_x_log10(breaks = c(3, 4, 5, 6, 8, 24, 48, 168, 336)) +
  ylim(0, 3) + 
  geom_point() +
  geom_line() +
  ylab("Percent modified peptides") +
  xlab("Time (hours)") +
  scale_color_discrete(name = "Biol. repeat")

# odds modified to other
plot2 <- ggplot(minus2mod, aes(x=time, y=odds.mod.other, color=biol.rep)) +
  scale_x_log10(breaks = c(3, 4, 5, 6, 8, 24, 48, 168, 336)) +
  scale_y_log10(breaks = c(.03, .04, .05, .06, .07, .08, .09, .1, .2, .3, .4, .5, .6, .7, .8, .9, 1, 2, 3, 4, 5),
                labels = c("0.03", "", "", "", "", "", "", "0.1", "", "0.3", "", "", "", "", "", "", "1.0", "", "3.0", "", ""),
                limits = c(.03, 1)) + 
  geom_point() +
  geom_line() +
  ylab("Odds -2 Da / other") +
  xlab("Time (hours)") +
  scale_color_discrete(name = "Biol. repeat")

plot_grid(plot1, plot2, labels = c("A", "B"))
```

Neither the percent modified peptides nor the odds show a significant trend over time:
```{r}
perc.model <- lm(frac.mod.abs ~ log(time), data=minus2mod)
summary(perc.model)
odds.model <- lm(odds.mod.other ~ log(time), data=minus2mod)
summary(odds.model)
```
